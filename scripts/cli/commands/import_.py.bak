import json
import subprocess
import sys
from pathlib import Path
from scripts.cli.core import get_project_paths, ensure_dirs, load_vars, load_settings, api_get

def cmd_import(args):
    """Unified Discovery & Attachment script with Analytics Region detection."""
    name = args.name
    requested_project_id = args.project
    force = getattr(args, 'force', False)
    
    var_file, state_file = get_project_paths(name)
    existing_vars = load_vars(name)
    existing_project_id = existing_vars.get('gcp_project_id')

    # Load global settings
    settings = load_settings()

    # 1. Resolve Project ID
    if not requested_project_id:
        print(f"Searching for project with label 'apigee-tf:{name}'...")
        try:
            cmd = ["gcloud", "projects", "list", f"--filter=labels.apigee-tf:{name}", "--format=json"]
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            projects = json.loads(result.stdout)
            if not projects:
                if existing_project_id:
                    print(f"No label found, using existing Project ID from config: {existing_project_id}")
                    requested_project_id = existing_project_id
                else:
                    print(f"Error: No projects found with label 'apigee-tf:{name}'.")
                    sys.exit(1)
            else:
                requested_project_id = projects[0]['projectId']
        except Exception as e:
            print(f"Error during project discovery: {e}")
            sys.exit(1)

    # 2. Safety Check: Project ID Conflict
    if existing_project_id and existing_project_id != requested_project_id:
        if not force:
            print(f"CRITICAL: Name '{name}' is already attached to project '{existing_project_id}'.")
            print(f"Action: Use --force to clear state and re-attach to '{requested_project_id}'.")
            sys.exit(1)
        else:
            print(f"WARNING: --force detected. Clearing existing config/state for '{name}'...")
            if var_file.exists(): var_file.unlink()
            if state_file.exists(): state_file.unlink()
            existing_vars = {}

    print(f"Project ID: {requested_project_id}")
    
    # 3. Resolve Intent
    intent_region = args.region or existing_vars.get('apigee_runtime_location')
    domain_template = settings.get("domain_template")
    intent_domain = args.domain or existing_vars.get('domain_name') or (domain_template.format(nickname=name) if domain_template else None)
    
    # 4. Probe API (Truth)
    print(f"Probing Apigee API for existing resources...")
    imports = []
    discovered_runtime_location = None
    discovered_analytics_region = None
    discovered_env_names = []
    discovered_eg_names = []
    
    # Probe Org
    org_data = api_get(f"organizations/{requested_project_id}")
    discovered_control_plane = ""  # Default: global/no DRZ
    if org_data:
        print(f"  [+] Found Apigee Org (State: {org_data.get('state')})")
        discovered_analytics_region = org_data.get("analyticsRegion")
        if discovered_analytics_region:
            print(f"      Analytics Region (Immutable): {discovered_analytics_region}")
        
        # Try to detect control plane location from apiConsumerDataLocation
        api_consumer_data_loc = org_data.get("apiConsumerDataLocation")
        if api_consumer_data_loc:
            # Map region to control plane (e.g., northamerica-northeast1 -> ca)
            if api_consumer_data_loc.startswith("northamerica-northeast"):
                discovered_control_plane = "ca"
            elif api_consumer_data_loc.startswith("europe-"):
                discovered_control_plane = "eu"
            print(f"      Control Plane Location: {discovered_control_plane} (from apiConsumerDataLocation)")
            
        imports.append({
            "to": "module.apigee_core.google_apigee_organization.apigee_org",
            "id": f"organizations/{requested_project_id}"
        })
        
        # Probe Instance
        inst_data = api_get(f"organizations/{requested_project_id}/instances")
        if inst_data and "instances" in inst_data:
            for inst in inst_data["instances"]:
                print(f"  [+] Found Instance: {inst['name']} ({inst['location']})")
                discovered_runtime_location = inst['location']
                imports.append({
                    "to": "module.apigee_core.google_apigee_instance.apigee_instance",
                    "id": f"organizations/{requested_project_id}/instances/{inst['name']}"
                })

        # Probe Maps
        eg_data = api_get(f"organizations/{requested_project_id}/envgroups")
        discovered_eg_names = [eg['name'] for eg in eg_data.get("environmentGroups", [])] if eg_data else []
        for eg in discovered_eg_names:
            imports.append({
                "to": f"module.apigee_core.google_apigee_envgroup.envgroup[\"{eg}\"]",
                "id": f"organizations/{requested_project_id}/envgroups/{eg}"
            })

        env_data = api_get(f"organizations/{requested_project_id}/environments")
        discovered_env_names = env_data if env_data and isinstance(env_data, list) else []
        for env in discovered_env_names:
            imports.append({
                "to": f"module.apigee_core.google_apigee_environment.apigee_env[\"{env}\"]",
                "id": f"organizations/{requested_project_id}/environments/{env}"
            })

    # Probe Ingress LB IP
    try:
        addr_name = "apigee-ingress-ip"
        cmd = ["gcloud", "compute", "addresses", "describe", addr_name, "--global", f"--project={requested_project_id}", "--format=json"]
        if subprocess.run(cmd, capture_output=True).returncode == 0:
            print(f"  [+] Found Global Address: {addr_name}")
            imports.append({
                "to": "module.ingress_lb.google_compute_global_address.lb_ip",
                "id": f"projects/{requested_project_id}/global/addresses/{addr_name}"
            })
    except: pass

    # 5. Validation & Conflict Logic
    
    # Check Runtime Conflict
    if intent_region and discovered_runtime_location and intent_region != discovered_runtime_location:
         print(f"\nERROR: Runtime Location Conflict!")
         print(f"  Specified: {intent_region}")
         print(f"  Existing Instance: {discovered_runtime_location}")
         sys.exit(1)

    final_runtime = discovered_runtime_location or intent_region
    # If Org exists, Analytics is FIXED to discovered value. Otherwise use Runtime.
    final_analytics = discovered_analytics_region or final_runtime

    if not final_runtime:
        print("\nERROR: Cannot determine runtime region. Provide --region <id>.")
        sys.exit(1)
    if not intent_domain:
         print("\nERROR: Cannot determine domain. Provide --domain <name>.")
         sys.exit(1)

    # 6. Save/Update Config
    ensure_dirs()
    if not var_file.exists():
        with open(var_file, 'w') as f:
            f.write(f'gcp_project_id          = "{requested_project_id}"\n')
            f.write(f'domain_name             = "{intent_domain}"\n')
            f.write(f'apigee_analytics_region = "{final_analytics}"\n')
            f.write(f'apigee_runtime_location = "{final_runtime}"\n')
            f.write(f'project_nickname        = "{name}"\n')
            f.write(f'control_plane_location  = "{discovered_control_plane}"\n')
        print(f"Created {var_file}")
        existing_vars = load_vars(name)
    else:
        # Sync logic
        sync_needed = False
        new_vars_lines = []
        with open(var_file, 'r') as f:
            existing_lines = f.readlines()

        if discovered_analytics_region and existing_vars.get('apigee_analytics_region') != discovered_analytics_region:
            print(f"  [!] Correcting Analytics Region to match immutable cloud truth: {discovered_analytics_region}")
            sync_needed = True

        # Check if control_plane_location exists in config
        has_control_plane = any('control_plane_location' in line for line in existing_lines)
        for line in existing_lines:
            skip = False
            if '=' in line and not line.strip().startswith('#'):
                key = line.split('=')[0].strip()
                if key == 'apigee_runtime_location' and final_runtime != existing_vars.get('apigee_runtime_location'):
                   new_vars_lines.append(f'apigee_runtime_location = "{final_runtime}"\n')
                   sync_needed = True; skip = True
                elif key == 'apigee_analytics_region' and final_analytics != existing_vars.get('apigee_analytics_region'):
                   new_vars_lines.append(f'apigee_analytics_region = "{final_analytics}"\n')
                   sync_needed = True; skip = True
                elif key == 'control_plane_location' and discovered_control_plane != existing_vars.get('control_plane_location', ''):
                   new_vars_lines.append(f'control_plane_location  = "{discovered_control_plane}"\n')
                   sync_needed = True; skip = True
            if not skip:
                new_vars_lines.append(line)

        # Add control_plane_location if missing
        if not has_control_plane:
            new_vars_lines.append(f'control_plane_location  = "{discovered_control_plane}"\n')
            sync_needed = True

        if sync_needed:
            with open(var_file, 'w') as f:
                f.writelines(new_vars_lines)
            print(f"Synced {var_file} with cloud truth.")

    # 7. Map Vars Sync (Environments/EnvGroups)
    if discovered_env_names or discovered_eg_names:
        sync_needed = False
        new_vars_lines = []
        with open(var_file, 'r') as f:
             existing_lines = f.readlines()
        
        found_keys = set()
        for line in existing_lines:
            if '=' in line and not line.strip().startswith('#'):
                found_keys.add(line.split('=')[0].strip())
            new_vars_lines.append(line)

        if discovered_env_names and 'environments' not in found_keys:
            env_map = "{\n" + ",\n".join([f'    "{e}" = {{}}' for e in discovered_env_names]) + "\n  }"
            new_vars_lines.append(f'\nenvironments = {env_map}\n')
            sync_needed = True
        
        if discovered_eg_names and 'envgroups' not in found_keys:
            eg_map = "{\n" + ",\n".join([f'    "{eg}" = {json.dumps(discovered_env_names)}' for eg in discovered_eg_names]) + "\n  }"
            new_vars_lines.append(f'envgroups = {eg_map}\n')
            sync_needed = True

        if sync_needed:
            with open(var_file, 'w') as f:
                f.writelines(new_vars_lines)
            print(f"Mapped discovered resources to {var_file}")

    # 8. Import Blocks
    if imports:
        import_file = Path("generated_imports.tf")
        with open(import_file, 'w') as f:
            f.write("# Generated by ./util import\n\n")
            for imp in imports:
                f.write(f'import {{\n  to = {imp["to"]}\n  id = "{imp["id"]}"\n}}\n\n')
        print(f"\nGenerated {import_file}")
    else:
        print("\nProject truly empty. Ready for 'apply'.")
