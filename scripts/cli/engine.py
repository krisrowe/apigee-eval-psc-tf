import os
import sys
import shutil
import hashlib
import json
from pathlib import Path
from rich.console import Console
from scripts.cli.config import Config

console = Console()

class TerraformStager:
    """Stages Terraform configuration in XDG cache for execution."""
    
    CACHE_DIR_NAME = "apim"

    def __init__(self, config: Config):
        self.config = config
        self.project_root = config.root_dir
        self.staging_dir = self._get_staging_dir()
        self.package_root = self._find_package_root()

    def _get_staging_dir(self) -> Path:
        """Calculates stable cache path based on project root hash."""
        xdg_cache = os.environ.get("XDG_CACHE_HOME", str(Path.home() / ".cache"))
        project_hash = hashlib.sha256(str(self.project_root).encode()).hexdigest()[:12]
        return Path(xdg_cache) / self.CACHE_DIR_NAME / "projects" / f"{self.config.project.name}_{project_hash}"

    def _find_package_root(self) -> Path:
        """Locates the installed package root (contains main.tf, modules/, etc.)."""
        current_file = Path(__file__)
        # scripts/cli/engine.py -> ../../ = package root
        package_root = current_file.parents[2]
        
        if not (package_root / "main.tf").exists():
            raise FileNotFoundError(f"Could not locate package root at {package_root}")
        return package_root

    def stage(self):
        """Performs the Wipe & Copy strategy."""
        console.print(f"[dim]Staging Terraform in {self.staging_dir}...[/dim]")
        
        if not self.staging_dir.exists():
            self.staging_dir.mkdir(parents=True)

        # 1. WIPE: Remove old TF files, preserve .terraform cache
        self._wipe_staging()

        # 2. COPY PACKAGE TF: Copy base TF files from package
        self._copy_package_tf()

        # 3. GENERATE BACKEND: Create backend.tf pointing to state location
        self._generate_backend()

        # 4. GENERATE TFVARS: Create auto.tfvars.json from config
        self._generate_tfvars()

        # 5. COPY USER TF: Copy user's overlay *.tf and *.tfvars files
        self._copy_user_files()

    def _wipe_staging(self):
        """Removes all *.tf and *.tfvars files, preserves .terraform folder."""
        for pattern in ["*.tf", "*.tfvars", "*.tfvars.json"]:
            for item in self.staging_dir.glob(pattern):
                item.unlink()
        # Also remove modules folder to get fresh copy
        modules_dest = self.staging_dir / "modules"
        if modules_dest.exists():
            shutil.rmtree(modules_dest)

    def _copy_package_tf(self):
        """Copies the base TF files and modules from the package."""
        # Copy root TF files
        for tf_file in ["main.tf", "variables.tf", "providers.tf", "outputs.tf"]:
            src = self.package_root / tf_file
            if src.exists():
                shutil.copy2(src, self.staging_dir / tf_file)
        
        # Copy the modules folder
        src_modules = self.package_root / "modules"
        dest_modules = self.staging_dir / "modules"
        if src_modules.exists():
            shutil.copytree(src_modules, dest_modules)
        
        console.print(f"[dim]Copied base Terraform configuration.[/dim]")

    def _generate_backend(self):
        """Generates backend.tf to use shared state location."""
        # State files live at ~/.local/share/apigee-tf/states/<project_name>.tfstate
        xdg_data = os.environ.get("XDG_DATA_HOME", str(Path.home() / ".local" / "share"))
        state_dir = Path(xdg_data) / "apigee-tf" / "states"
        state_dir.mkdir(parents=True, exist_ok=True)
        
        state_path = state_dir / f"{self.config.project.name}.tfstate"
        
        backend_tf = f'''# AUTO-GENERATED BY APIM - DO NOT EDIT
terraform {{
  backend "local" {{
    path = "{state_path}"
  }}
}}
'''
        with open(self.staging_dir / "_apim_gen_backend.tf", "w") as f:
            f.write(backend_tf)

    def _generate_tfvars(self):
        """Generates auto.tfvars.json from apigee.toml config."""
        tfvars_content = {
            "gcp_project_id": self.config.project.gcp_project_id,
            "apigee_runtime_location": self.config.project.region,
            "apigee_analytics_region": self.config.apigee.analytics_region,
            "domain_name": self.config.network.domain or "",
            "project_nickname": self.config.project.nickname,
            "control_plane_location": self.config.apigee.control_plane_location,
        }
        
        # Only include consumer_data_region if set (DRZ mode)
        if self.config.apigee.consumer_data_region:
            tfvars_content["consumer_data_region"] = self.config.apigee.consumer_data_region
        
        tfvars_path = self.staging_dir / "_apim_gen.auto.tfvars.json"
        with open(tfvars_path, "w") as f:
            json.dump(tfvars_content, f, indent=2)

    def _copy_user_files(self):
        """Copies user's overlay *.tf and *.tfvars files from project root."""
        # Reserved prefixes to block
        reserved_prefixes = ["_apim_"]
        
        count = 0
        for pattern in ["*.tf", "*.tfvars", "*.tfvars.json"]:
            for source_file in self.project_root.glob(pattern):
                # Check for reserved prefix collision
                for prefix in reserved_prefixes:
                    if source_file.name.startswith(prefix):
                        console.print(f"[red]Error: {source_file.name} uses reserved prefix '{prefix}'. Please rename it.[/red]")
                        sys.exit(1)
                
                dest = self.staging_dir / source_file.name
                shutil.copy2(source_file, dest)
                count += 1
        
        if count > 0:
            console.print(f"[dim]Copied {count} user overlay file(s).[/dim]")
